<!DOCTYPE html>
<html>
<head>
  <title>Admin - Maktab</title>
</head>
<body>
  <h1>üîê Admin Panel</h1>

  <form id="adminForm">
    <input type="password" id="password" placeholder="Admin Password" required><br><br>
    <input type="text" id="title" placeholder="Book Title" required>
    <input type="text" id="author" placeholder="Author">
    <input type="text" id="price" placeholder="Price"><br><br>
    <input type="text" id="imageUrl" placeholder="Image URL"><br><br>
    <button type="submit">Add Book</button>
  </form>

      <p>After submitting, the books will automatically update on the site.</p>

  <h2>Existing Books</h2>
  <div id="bookList"></div>

  <script>
    const workerURL = "https://patient-meadow-010b.shahshadab1680.workers.dev/"; // Your Cloudflare Worker URL

    async function sendToWorker(payload) {
      const res = await fetch(workerURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if(res.ok){
        alert(`${payload.action} book successfully!`);
        document.getElementById("adminForm").reset();
        loadBooks(); // Reload books after action
      } else {
        const errorText = await res.text();
        alert(`Failed to ${payload.action} book. Error: ${errorText}`);
      }
    }

    document.getElementById("adminForm").addEventListener("submit", async e => {
      e.preventDefault();

      const payload = {
        action: "add",
        password: document.getElementById("password").value,
        title: document.getElementById("title").value,
        author: document.getElementById("author").value,
        price: document.getElementById("price").value,
        imageUrl: document.getElementById("imageUrl").value
      };
      sendToWorker(payload);
    });

    async function loadBooks() {
      const res = await fetch("books.json");
      const data = await res.json();
      const bookList = document.getElementById("bookList");
      bookList.innerHTML = ""; // Clear existing list

      data.categories.forEach(cat => {
        bookList.innerHTML += `<h3>${cat.name}</h3>`;
        cat.books.forEach((book, index) => { // Added index for edit/delete
          bookList.innerHTML += `
            <div class="book-item">
              <p><b>${book.title}</b> by ${book.author} (${book.price})</p>
              <img src="${book.imageUrl}" alt="${book.title}" width="100">
              <button onclick="editBook('${book.title}', '${book.author}', '${book.price}', '${book.imageUrl}', ${index})">Edit</button>
              <button onclick="deleteBook(${index})">Delete</button>
            </div>
          `;
        });
      });
    }

    // Call loadBooks on page load
    loadBooks();

    async function editBook(title, author, price, imageUrl, index) {
      const newTitle = prompt("Enter new title:", title);
      if (!newTitle) return;
      const newAuthor = prompt("Enter new author:", author);
      const newPrice = prompt("Enter new price:", price);
      const newImageUrl = prompt("Enter new image URL:", imageUrl);

      const payload = {
        action: "edit",
        password: document.getElementById("password").value,
        title: newTitle,
        author: newAuthor,
        price: newPrice,
        imageUrl: newImageUrl,
        index: index
      };
      sendToWorker(payload);
    }

    async function deleteBook(index) {
      if (!confirm("Are you sure you want to delete this book?")) return;

      const payload = {
        action: "remove", // Use "remove" as defined in workflow
        password: document.getElementById("password").value,
        index: index
      };
      sendToWorker(payload);
    }
  </script>
</body>
</html>
